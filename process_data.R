library(data.table); library(lubridate); factor_df_new <- factor_df[, .(eid, p200)]; date_cols <- names(factor_df)[sapply(factor_df, function(x) class(x)[1] == "IDate")]; date_cols <- date_cols[date_cols != "p200"]; factor_df_new[, date := as.IDate(NA)]; factor_df_new[, date_gap := NA_real_]; for(i in 1:nrow(factor_df_new)) { p200_date <- factor_df_new$p200[i]; if(!is.na(p200_date)) { row_dates <- factor_df[i, date_cols, with = FALSE]; valid_dates <- as.vector(unlist(row_dates)); valid_dates <- valid_dates[!is.na(valid_dates)]; future_dates <- valid_dates[valid_dates > p200_date]; if(length(future_dates) > 0) { closest_date <- future_dates[which.min(future_dates - p200_date)]; factor_df_new$date[i] <- closest_date; months_diff <- interval(p200_date, closest_date) %/% months(1); factor_df_new$date_gap[i] <- months_diff; } } }; print(head(factor_df_new, 10))
